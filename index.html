<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Serce Gotowe ‚Äî Ksiƒôga (lista 2 w rzƒôdzie)</title>

<link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg: #9fc6e2;
    --bg2: #cfe8f8;
    --navy: #1e3a8a;
    --quote-grad-start: #3b5998;
    --quote-grad-end: #5a8dee;
    --accent: #2b7bd6;
    --glass-border: rgba(255,255,255,0.36);
  }

  html,body{height:100%;margin:0;font-family:Roboto,system-ui,-apple-system,"Segoe UI",Arial;}
  body{
    background: linear-gradient(180deg,var(--bg) 0%,var(--bg2) 100%);
    background-repeat: no-repeat;
    background-attachment: fixed;
    background-size: 100% 100vh;
    min-height: 100vh;
    color:var(--navy);
    -webkit-font-smoothing:antialiased;
  }
  @media (max-width:420px){
    body{ background-attachment: scroll; background-size: 100% 200vh; }
  }

  .container{max-width:720px;margin:18px auto;padding:18px;}
  header{text-align:center;margin-bottom:32px;}
  .title{font-family:Pacifico,cursive;font-size:36px;color:var(--navy);margin:0;line-height:1;position:relative;z-index:1}

  .card{background:rgba(255,255,255,0.95);border-radius:16px;padding:16px;box-shadow:0 8px 20px rgba(6,21,52,0.12);border:1px solid rgba(30,58,138,0.06)}
  .draw-area{display:flex;flex-direction:column;gap:12px;align-items:center}

  .preview{
    width:100%;
    height:200px;
    border-radius:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    background:linear-gradient(180deg,rgba(255,255,255,0.9),rgba(255,255,255,0.88));
    border:1px solid rgba(30,58,138,0.04);
    overflow:hidden;
    position:relative;
  }
  .preview img{max-width:70%;max-height:80%;object-fit:contain;border-radius:8px;transition:transform .3s ease,filter .45s ease;display:block;margin:auto}
  .preview img.dimmed{filter:brightness(0.35) grayscale(0.15)}
  .preview .placeholder{font-weight:700;color:var(--navy);text-align:center;padding:12px}
  .preview .preview-overlay{position:absolute;opacity:0;display:flex;align-items:center;justify-content:center;width:72px;height:72px;border-radius:50%;background:rgba(0,0,0,0.45);color:white;font-weight:900;font-size:32px;text-shadow:0 6px 10px rgba(0,0,0,0.45);pointer-events:none;transition:opacity .45s ease}
  .preview.show-overlay .preview-overlay{display:flex;opacity:1}

  .controls{display:flex;width:100%;gap:10px;align-items:center}
  .btn{flex:1;border:none;padding:12px 14px;border-radius:12px;font-weight:700;cursor:pointer;background:linear-gradient(90deg,var(--quote-grad-start),var(--quote-grad-end));color:#fff}
  .btn.ghost{background:#fff;border:2px solid rgba(30,58,138,0.12);color:var(--navy);box-shadow:none}
  .btn.inactive{background: #cbd5e1; color: rgba(5,32,63,0.7); cursor:default}

  .btn.book{background:linear-gradient(90deg,var(--quote-grad-start),var(--quote-grad-end));border-radius:14px;padding:12px 16px;border:1px solid rgba(0,0,0,0.06);display:inline-flex;align-items:center;gap:10px;justify-content:center;box-shadow:0 10px 24px rgba(30,58,138,0.08);color:#fff;font-weight:900;transition:transform .16s ease,box-shadow .16s ease}
  .btn.book .icon{font-size:18px;color:#fff}
  .btn.book:hover{transform:translateY(-3px);box-shadow:0 18px 40px rgba(30,58,138,0.16)}
  @media (max-width:420px){ .btn.book{width:100%} }

  .countdowns-grid{display:flex;gap:10px;flex-wrap:wrap;align-items:stretch}
  .countdown-card{flex:0 0 calc(50% - 5px);max-width:calc(50% - 5px);box-sizing:border-box;min-width:120px;background:linear-gradient(180deg,#ffffff,#f7fbff);border-radius:10px;padding:10px;border:1px solid rgba(30,58,138,0.06);box-shadow:0 6px 14px rgba(6,21,52,0.06);text-align:center}
  .countdown-label{font-size:12px;font-weight:700;color:rgba(5,32,63,0.7)}
  .countdown-value{font-variant-numeric:tabular-nums;font-weight:900;color:var(--navy);font-size:18px;margin-top:6px}
  .countdown-sub{font-size:12px;color:rgba(5,32,63,0.6);margin-top:6px}

  .caption{font-weight:700;color:var(--navy);text-align:center;min-height:48px;display:flex;align-items:center;justify-content:center;padding:8px 6px}
  .cooldowns{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .tiny{font-size:12px;font-weight:700;color:rgba(5,32,63,0.7)}
  .book-area{margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:center}

  .modal-backdrop{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    z-index:2000;
    padding:14px;
    background: transparent;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
  }
  .modal-backdrop.show{display:flex}

  .modal{
    width:100%;
    max-width:560px;
    background: rgba(255,255,255,0.06);
    border: 1px solid var(--glass-border);
    border-radius:14px;
    box-shadow:
      0 8px 24px rgba(6,21,52,0.10),
      inset 0 1px 0 rgba(255,255,255,0.6);
    backdrop-filter: blur(30px) saturate(120%);
    -webkit-backdrop-filter: blur(30px) saturate(120%);
    position:relative;
    overflow:visible;
    max-height: calc(100vh - 40px);
    display:flex;
    flex-direction:column;
    transition: background .22s ease, box-shadow .22s ease, border .22s ease;
  }
  .modal.short-modal{ max-height: 60vh; }

  .modal-inner{padding:14px; position: relative; z-index: 10; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius: 12px;}
  .modal-header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .modal-title{font-family:Pacifico;color:var(--navy);font-size:22px;margin:0}

  .mission{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
  .mission-title{font-weight:700;font-size:13px;color:var(--navy)}
  .mission-row{display:flex;align-items:center;gap:8px}
  .mission-count{font-weight:900;color:var(--navy);background:linear-gradient(90deg,var(--quote-grad-start),var(--quote-grad-end));color:#fff;padding:6px 10px;border-radius:12px;font-size:13px;box-shadow:0 8px 18px rgba(30,58,138,0.12)}
  .mission-badge{font-size:18px;margin-left:4px}
  .mission-small{font-size:12px;color:rgba(5,32,63,0.65);margin-top:2px}

  .close{border:none;background:transparent;font-size:20px;cursor:pointer;color:var(--navy)}

  .modal-body{
    width:100%;
    overflow-y:auto;
    overflow-x:hidden;
    padding:12px 18px 18px 18px;
    background: rgba(255,255,255,0.01);
    box-sizing:border-box;
    scroll-behavior:smooth;
    scrollbar-width: auto;
    -ms-overflow-style: auto;
    flex:1;
    min-height:0;
  }

  .grid{
    display:grid;
    grid-template-columns: repeat(2, 1fr);
    gap:12px;
    justify-content:stretch;
    align-content:flex-start;
    max-width:520px;
    margin:0 auto;
    box-sizing:border-box;
    width:100%;
  }
  .cardItem{
    box-sizing:border-box;
    background:#fff;
    border-radius:10px;
    border:1px solid rgba(30,58,138,0.04);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    gap:8px;
    padding:10px;
    overflow:visible;
    min-width:0;
    text-align:center;
  }
  .imgWrap{
    width:100%;
    aspect-ratio:1/1;
    max-width:220px;
    position:relative;
    overflow:hidden;
    border-radius:8px;
    background:linear-gradient(90deg,var(--quote-grad-start),var(--quote-grad-end));
    display:flex;
    align-items:center;
    justify-content:center;
    padding:6px;
    box-sizing:border-box;
    margin:0 auto;
  }
  .cardItem img{max-width:90%;max-height:90%;object-fit:contain;border-radius:6px;transition:filter .18s ease,transform .18s ease;background:transparent;display:block;margin:auto}
  .cardItem.dimmed img{filter:brightness(0.35) grayscale(0.15)}
  .imgWrap .overlay{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-weight:900;font-size:48px;color:rgba(255,255,255,0.95);pointer-events:none;display:none;align-items:center;justify-content:center;text-shadow:0 6px 10px rgba(0,0,0,0.45)}
  .cardItem.dimmed .imgWrap .overlay{display:flex;background:rgba(0,0,0,0.45);width:72px;height:72px;border-radius:50%;font-size:36px}
  .cardItem .name{font-weight:900;color:var(--navy);text-align:center;font-size:14px;margin-top:6px;word-break:break-word}
  .cardItem .desc{font-size:12px;color:rgba(5,32,63,0.8);text-align:center;padding:6px 4px;word-break:break-word}

  @media (max-width:420px){
    .modal{max-width:100%; margin:8px; padding-right:8px; border-radius:12px;}
    .preview{height:140px}
    .preview img{max-width:70%}
    .countdown-card{padding:8px;flex:1 1 100%}
    .countdown-value{font-size:16px}
    .cardItem{padding:8px}
    .imgWrap{padding:4px; max-width:180px}
    .cardItem .name{font-size:13px}
    .cardItem .desc{font-size:11px}
    .mission{align-items:flex-start;min-width:0}
    .modal-header{gap:8px}
    .controls{flex-direction:column;align-items:stretch}
    .controls .btn{width:100%}
    .grid{grid-template-columns: repeat(2, 1fr); gap:12px; padding:6px;}
    .modal{max-height: calc(100vh - 24px);}    
    .modal.short-modal{ max-height: 50vh; }
    .modal-body{padding-bottom:28px;}
  }

  img{max-width:100%;height:auto;-o-object-fit:contain}

  /* -----------------------------
     SETTINGS BUTTON & PANEL (CENTERED)
     ----------------------------- */
  .settings-btn{
    position:fixed;
    right:18px;
    top:50%;
    transform:translateY(-50%);
    width:56px;
    height:56px;
    border-radius:50%;
    background: rgba(255,255,255,0.10);
    border:1px solid rgba(255,255,255,0.18);
    backdrop-filter: blur(10px) saturate(120%);
    -webkit-backdrop-filter: blur(10px) saturate(120%);
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    z-index:3000;
    box-shadow: 0 10px 30px rgba(2,6,23,0.12);
    transition:transform .15s ease, box-shadow .15s ease, visibility .12s linear;
    color:var(--navy);
    font-size:20px;
    line-height:1;
    visibility: visible;
  }
  .settings-btn:active{ transform:translateY(-50%) scale(.98); }
  .settings-btn:focus{ outline:3px solid rgba(0,0,0,0.06); outline-offset:2px; }

  /* ICON */
  #settingsIcon{
    display:inline-block;
    font-size:20px;
    line-height:1;
    transition:opacity .18s ease, transform .18s ease;
    opacity:1;
    color:var(--navy);
  }

  /* BACKDROP: centrowanie panelu */
  .settings-backdrop{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;      /* <-- wy≈õrodkowanie pionowe */
    justify-content:center;  /* <-- wy≈õrodkowanie poziome */
    z-index:2999;
    padding:18px;
    background: transparent;
  }
  .settings-backdrop.show{ display:flex; }

  .settings-panel{
    width:320px;
    max-width:calc(100% - 40px);
    background: rgba(255,255,255,0.06);
    border:1px solid var(--glass-border);
    border-radius:12px;
    padding:12px;
    box-shadow: 0 12px 36px rgba(2,6,23,0.12);
    backdrop-filter: blur(18px) saturate(120%);
    -webkit-backdrop-filter: blur(18px) saturate(120%);
    display:flex;
    flex-direction:column;
    gap:8px;
    z-index:3000;
    max-height: 44vh;
    overflow: hidden;
    transition: max-height .36s cubic-bezier(.2,.9,.3,1), transform .18s ease;
    transform: none;
  }
  .settings-panel.show {
    max-height: 72vh;
  }

  .settings-panel .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .settings-panel h3{margin:0;font-size:14px;color:var(--navy);font-weight:900}

  .theme-list{
    display:grid;
    grid-template-columns:repeat(2,1fr);
    gap:8px;
    margin-top:8px;
    max-height: calc( (44vh - 120px) / 2 );
    overflow-y: auto;
    padding-right:6px;
  }

  .theme-option{
    display:flex;
    align-items:center;
    gap:8px;
    padding:8px;
    border-radius:10px;
    border:1px solid rgba(0,0,0,0.04);
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    cursor:pointer;
    min-height:48px;
    text-align:left;
    box-shadow: 0 6px 12px rgba(2,6,23,0.06);
  }
  .theme-option:focus{ outline:2px solid rgba(0,0,0,0.06); }

  .swatch{
    width:44px;
    height:44px;
    border-radius:50%;
    box-shadow: inset 0 -3px 0 rgba(0,0,0,0.06);
    flex-shrink:0;
    border:2px solid rgba(0,0,0,0.06);
    overflow:hidden;
    position:relative;
    display:block;
    margin:0;
    background: transparent;
  }
  .swatch .swatch-gradient{
    position:absolute;
    inset:4px;
    border-radius:50%;
    box-shadow: inset 0 -3px 0 rgba(0,0,0,0.06);
  }
  .swatch .swatch-accent{
    position:absolute;
    width:12px;
    height:12px;
    border-radius:50%;
    right:6px;
    bottom:6px;
    border:2px solid rgba(255,255,255,0.92);
    box-shadow: 0 2px 6px rgba(0,0,0,0.12);
  }
  .swatch .swatch-ring{
    position:absolute;
    inset:0;
    border-radius:50%;
    pointer-events:none;
    box-shadow: 0 0 0 2px rgba(255,255,255,0.02) inset;
  }

  .theme-option .meta{font-size:13px;font-weight:700;color:var(--navy)}
  .theme-option .sub{font-size:11px;font-weight:600;color:rgba(5,32,63,0.6)}

  .settings-footer{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:6px}
  .text-muted{font-size:12px;color:rgba(5,32,63,0.6)}
  .small-btn{padding:8px 10px;border-radius:10px;border:none;background:transparent;color:var(--navy);font-weight:700;cursor:pointer}
  .small-btn.ghost{border:1px solid rgba(255,255,255,0.06);background:transparent}
  @media (max-width:520px){
    .settings-panel{ width:320px; max-width:calc(100% - 40px); max-height: 40vh; }
    .settings-panel.show { max-height: 58vh; }
    .theme-list{ max-height: 34vh; }
  }

  @keyframes spinOut {
    0% { transform: translateY(-50%) rotate(0deg) scale(1); opacity:1; }
    70% { transform: translateY(-50%) rotate(300deg) scale(0.6); opacity:0.8; }
    100% { transform: translateY(-50%) rotate(540deg) scale(0.2); opacity:0; }
  }
  .spin-out{ animation: spinOut 420ms cubic-bezier(.2,.9,.3,1) forwards; }

  @keyframes spinIn {
    0% { transform: translateY(-50%) rotate(-360deg) scale(0.25); opacity:0; }
    70% { transform: translateY(-50%) rotate(20deg) scale(1.12); opacity:1; }
    100% { transform: translateY(-50%) rotate(0deg) scale(1); opacity:1; }
  }
  .spin-in{ display:flex !important; animation: spinIn 560ms cubic-bezier(.2,.9,.3,1) forwards; }

  .seasonal-title { font-size:12px; font-weight:900; color:var(--navy); margin-top:6px }
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1 class="title">Serce Gotowe</h1>
    </header>

    <section class="card draw-area" aria-labelledby="drawLabel">
      <div class="preview" id="preview">
        <img id="centralImg" src="" alt="Czekoladka" draggable="false" style="display:none">
        <div class="placeholder" id="placeholderText">Wylosuj Czekoladkƒô na dzi≈õ</div>
        <div class="preview-overlay" id="previewOverlay">?</div>
      </div>

      <div class="controls" style="width:100%;">
        <button id="drawBtn" class="btn">Wylosuj</button>
      </div>

      <div class="caption" id="caption">Kliknij ‚ÄûWylosuj‚Äù, aby otrzymaƒá dzisiejszƒÖ misjƒô.</div>

      <div class="cooldowns" style="width:100%;">
        <div class="countdowns-grid">
          <div class="countdown-card" id="drawCooldownCard" aria-live="polite">
            <div class="countdown-label">Nastƒôpne losowanie</div>
            <div class="countdown-value" id="drawCountdown">‚Äî</div>
            <div class="countdown-sub tiny">mo≈ºesz losowaƒá co 24h</div>
          </div>

          <div class="countdown-card" id="dec24Card" aria-live="polite">
            <div class="countdown-label">Do 24 grudnia</div>
            <div class="countdown-value" id="dec24">‚Äî</div>
            <div class="countdown-sub tiny">≈õwiƒôtujemy üéÑ</div>
          </div>
        </div>
      </div>
      <div class="book-area">
        <button id="openBook" class="btn book" style="width:100%;"><span class="icon">üìñ</span>Ksiƒôga Czekoladek</button>
      </div>
    </section>
  </div>

  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div class="modal-inner">
        <div class="modal-header">
          <div style="display:flex;gap:10px;align-items:center;">
            <div class="mission" style="min-width:150px;">
              <div class="mission-title">ZdobƒÖd≈∫ wszystkie</div>
              <div class="mission-row">
                <div class="mission-count"><span id="foundCount">0</span>/18</div>
                <div class="mission-badge" aria-hidden="true">üéÅ</div>
              </div>
            </div>
            <button class="close" id="closeModal" aria-label="Zamknij">‚úï</button>
          </div>
        </div>
      </div>

      <div class="modal-body" id="modalBody" aria-live="polite">
        <!-- grid wype≈Çniany przez JS -->
      </div>

      <div class="modal-inner" style="display:flex;flex-direction:column;gap:8px;"></div>
    </div>
  </div>

  <button id="settingsBtn" class="settings-btn" title="Ustawienia kolor√≥w" aria-haspopup="true" aria-expanded="false" aria-label="Ustawienia">
    <span id="settingsIcon" aria-hidden="true">‚öôÔ∏è</span>
  </button>

  <div id="settingsBackdrop" class="settings-backdrop" role="dialog" aria-label="Wyb√≥r schematu kolor√≥w" aria-hidden="true">
    <div id="settingsPanel" class="settings-panel" role="document" aria-hidden="true">
      <div class="row">
        <h3>Dostosuj wyglƒÖd aplikacji</h3>
        <button id="closeSettings" class="small-btn" aria-label="Zamknij panel">‚úï</button>
      </div>

      <div class="seasonal-title" style="display:none;">Sezonowe Kolory</div>
      <div class="theme-list" id="seasonalList" style="display:none;margin-bottom:6px;"></div>

      <div class="seasonal-title">Standardowe Kolory</div>
      <div class="theme-list" id="themeList"></div>

      <div class="settings-footer">
        <div></div>
        <div style="display:flex;gap:8px;">
          <button id="resetTheme" class="small-btn ghost">Reset</button>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
try{
  const THEMES = {
    "blue": { name: "Niebieski (domy≈õlny)", bg: "#9fc6e2", bg2: "#cfe8f8", navy: "#1e3a8a", start: "#3b5998", end: "#5a8dee", accent: "#2b7bd6" },
    "light-blue": { name: "Jasny b≈Çƒôkit", bg: "#bfdbfe", bg2: "#dbeafe", navy: "#1e40af", start: "#60a5fa", end: "#3b82f6", accent: "#2563eb" },
    "green": { name: "Zielony", bg: "#a7f3d0", bg2: "#d1fae5", navy: "#064e3b", start: "#059669", end: "#10b981", accent: "#047857" },
    "moldy-green": { name: "Sple≈õnia≈Ça ziele≈Ñ", bg: "#8b9467", bg2: "#a8b584", navy: "#3d4a2b", start: "#6b7c4f", end: "#5a6b42", accent: "#4a5635" },
    "gray": { name: "Szary", bg: "#e5e7eb", bg2: "#f3f4f6", navy: "#111827", start: "#4b5563", end: "#6b7280", accent: "#374151" },
    "bw": { name: "Czarno-bia≈Çy", bg: "#ffffff", bg2: "#f8f9fa", navy: "#000000", start: "#000000", end: "#333333", accent: "#666666" },
    "pink": { name: "R√≥≈ºowy", bg: "#fce7f3", bg2: "#fdf2f8", navy: "#831843", start: "#db2777", end: "#ec4899", accent: "#be185d" },
    "light-rose": { name: "Jasny r√≥≈ºany", bg: "#ffe4e6", bg2: "#fef2f2", navy: "#881337", start: "#f43f5e", end: "#e11d48", accent: "#dc2626" },
    "orange": { name: "Pomara≈Ñczowy", bg: "#fed7aa", bg2: "#fef3c7", navy: "#92400e", start: "#f59e0b", end: "#f97316", accent: "#d97706" },
    "pumpkin": { name: "Dojrza≈Ça dynia", bg: "#ff6b35", bg2: "#ffedd5", navy: "#7c2d12", start: "#ea580c", end: "#dc2626", accent: "#C2410c" },
    "purple": { name: "Fioletowy", bg: "#e9d5ff", bg2: "#f3e8ff", navy: "#581c87", start: "#8b5cf6", end: "#a855f7", accent: "#7c3aed" },
    "plum": { name: "≈öliwkowy", bg: "#c8b5d1", bg2: "#ebd9ea", navy: "#4a2c5a", start: "#8e4a9c", end: "#6b3775", accent: "#7a4285" },
    "beige": { name: "Be≈ºowy", bg: "#f7f3e9", bg2: "#fdf9f1", navy: "#8b4513", start: "#e6d7c3", end: "#d4b896", accent: "#c19a6b" },
    "latte": { name: "Spienione latte", bg: "#d4b896", bg2: "#e8d5b7", navy: "#5d4037", start: "#8d6e63", end: "#6d4c41", accent: "#795548" },

    /* --- nowe motywy dostarczone przez u≈ºytkownika --- */
    "mustard": { name: "Musztardowy", bg: "#d4a574", bg2: "#e8c9a1", navy: "#5a3e1b", start: "#b8860b", end: "#daa520", accent: "#996515" },
    "yellow": { name: "≈ª√≥≈Çty", bg: "#fef08a", bg2: "#fef9c3", navy: "#713f12", start: "#eab308", end: "#facc15", accent: "#ca8a04" },
    "granatowy": { name: "Granatowy", bg: "#93c5fd", bg2: "#bfdbfe", navy: "#1e3a8a", start: "#1e40af", end: "#1e3a8a", accent: "#1d4ed8" },
    "turquoise": { name: "Jasny turkus", bg: "#a5f3fc", bg2: "#cffafe", navy: "#164e63", start: "#06b6d4", end: "#0891b2", accent: "#0e7490" }
  };

  // Kolejno≈õƒá tƒôczowa ‚Äî od czerwieni/pink przez pomara≈Ñcz/≈º√≥≈Çƒá, zielenie, turkusy, niebieskie do fiole√≥w i neutralnych
  const STANDARD_ORDER = [
    "pink","light-rose",           // r√≥≈º / czerwie≈Ñ
    "pumpkin","orange",            // pomara≈Ñcz
    "mustard","yellow",            // musztarda / ≈º√≥≈Çty
    "beige","latte",               // ciep≈Çe neutralne
    "green","moldy-green",         // zielenie
    "turquoise","light-blue",      // turkus / jasny b≈Çƒôkit
    "blue","granatowy",            // niebieskie
    "plum","purple",               // fioletowe
    "gray","bw"                    // szaro≈õci / czarno-bia≈Çe
  ];
  const THEME_KEY = 'sg_theme_v1';

  const themeListEl = document.getElementById('themeList');
  const settingsBtn = document.getElementById('settingsBtn');
  const settingsPanel = document.getElementById('settingsPanel');
  const settingsBackdrop = document.getElementById('settingsBackdrop');
  const settingsIcon = document.getElementById('settingsIcon');

  function createOptionElement(key){
    const t = THEMES[key];
    const btn = document.createElement('button');
    btn.className = 'theme-option';
    btn.type = 'button';
    btn.setAttribute('data-theme', key);
    btn.setAttribute('title', t.name);
    btn.innerHTML = `
      <div class="swatch" aria-hidden="true"></div>
      <div style="flex:1;">
        <div class="meta">${t.name}</div>
        <div class="sub">${t.start} ¬∑ ${t.end}</div>
      </div>
    `;
    const sw = btn.querySelector('.swatch');

    const gradient = document.createElement('span');
    gradient.className = 'swatch-gradient';
    gradient.style.background = `linear-gradient(135deg, ${t.start}, ${t.end})`;

    const accentDot = document.createElement('span');
    accentDot.className = 'swatch-accent';
    accentDot.style.background = t.accent || t.start;

    const ring = document.createElement('span');
    ring.className = 'swatch-ring';
    ring.style.boxShadow = `0 0 0 2px rgba(0,0,0,0.04) inset, 0 0 0 1px rgba(255,255,255,0.02)`;

    sw.innerHTML = '';
    sw.appendChild(gradient);
    sw.appendChild(accentDot);
    sw.appendChild(ring);

    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      hideSettings();
      setTimeout(()=>{
        applyTheme(key);
        animateButtonIn();
      }, 180);
    });

    btn.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' || e.key === ' '){
        e.preventDefault();
        btn.click();
      }
    });

    return btn;
  }

  STANDARD_ORDER.forEach(k=>{
    if(!THEMES[k]) return;
    themeListEl.appendChild(createOptionElement(k));
  });

  function applyTheme(key){
    const t = THEMES[key];
    if(!t) return;
    const root = document.documentElement.style;
    root.setProperty('--bg', t.bg);
    root.setProperty('--bg2', t.bg2);
    root.setProperty('--navy', t.navy);
    root.setProperty('--quote-grad-start', t.start);
    root.setProperty('--quote-grad-end', t.end);
    root.setProperty('--accent', t.accent || t.start);
    if (isDarkColor(t.bg)) {
      root.setProperty('--glass-border', 'rgba(255,255,255,0.08)');
    } else {
      root.setProperty('--glass-border', 'rgba(255,255,255,0.36)');
    }
    try{ localStorage.setItem(THEME_KEY, key); }catch(e){}
    updateSettingsBtnColor();
  }

  function resetTheme(){
    try{ localStorage.removeItem(THEME_KEY); }catch(e){}
    applyTheme('blue');
    animateButtonIn();
  }

  function loadSavedTheme(){
    try{
      const saved = localStorage.getItem(THEME_KEY);
      if(saved && THEMES[saved]) { applyTheme(saved); return; }
    }catch(e){}
    applyTheme('blue');
  }

  function isDarkColor(hex){
    try{
      const c = hex.replace('#','');
      const r = parseInt(c.substring(0,2),16);
      const g = parseInt(c.substring(2,4),16);
      const b = parseInt(c.substring(4,6),16);
      const lum = 0.2126*r + 0.7152*g + 0.0722*b;
      return lum < 160;
    }catch(e){ return false; }
  }

  function updateSettingsBtnColor(){
    const nav = getComputedStyle(document.documentElement).getPropertyValue('--navy').trim();
    // ustawiamy kolor zar√≥wno na przycisk jak i na ikonƒô, na wszelki wypadek
    try{ settingsBtn.style.color = nav || 'var(--navy)'; }catch(e){}
    try{ if(settingsIcon) settingsIcon.style.color = nav || 'var(--navy)'; }catch(e){}
  }

  const closeSettings = document.getElementById('closeSettings');
  const resetBtn = document.getElementById('resetTheme');

  function showSettings(){
    if(!settingsBackdrop) return;
    settingsBackdrop.classList.add('show');
    settingsBackdrop.setAttribute('aria-hidden','false');
    settingsPanel.setAttribute('aria-hidden','false');
    settingsBtn.setAttribute('aria-expanded','true');
    settingsPanel.classList.add('show');
    const first = settingsPanel.querySelector('.theme-option');
    if(first) first.focus();
    setTimeout(()=>{ document.addEventListener('click', outsideClick); }, 50);
  }
  function hideSettings(){
    if(!settingsBackdrop) return;
    settingsBackdrop.classList.remove('show');
    settingsBackdrop.setAttribute('aria-hidden','true');
    settingsPanel.setAttribute('aria-hidden','true');
    settingsBtn.setAttribute('aria-expanded','false');
    settingsPanel.classList.remove('show');
    document.removeEventListener('click', outsideClick);

    // przy zamkniƒôciu przywracamy widoczno≈õƒá przycisku i ikonƒô (bez czekania na wyb√≥r motywu)
    animateButtonIn();

    setTimeout(()=>{
      try{ if(settingsBtn.style.display !== 'none') settingsBtn.focus(); }catch(e){}
    }, 320);
  }
  function outsideClick(e){
    if(!settingsPanel.contains(e.target) && !settingsBtn.contains(e.target)) hideSettings();
  }

  function animateButtonOutAndShowPanel(){
    // animujemy ikonƒô w d√≥≈Ç i chowamy wizualnie (visibility), ale nie usuwamy struktury DOM
    settingsBtn.classList.remove('spin-in');
    settingsBtn.classList.add('spin-out');
    settingsBtn.style.pointerEvents = 'none';
    if(settingsIcon) settingsIcon.style.opacity = '0';
    setTimeout(()=>{
      // zamiast display:none ‚Äî u≈ºywamy visibility, ≈Çatwiej przywr√≥ciƒá ikonƒô i unikamy "pustego" przycisku
      settingsBtn.style.visibility = 'hidden';
      settingsBtn.classList.remove('spin-out');
      settingsBtn.style.pointerEvents = '';
      showSettings();
    }, 420);
  }

  function animateButtonIn(){
    // przywracamy widoczno≈õƒá i ikonƒô, odpalamy animacjƒô wej≈õcia
    settingsBtn.style.visibility = 'visible';
    settingsBtn.style.display = 'flex';
    settingsBtn.classList.remove('spin-out');
    if(settingsIcon) settingsIcon.style.opacity = '0';
    setTimeout(()=>{
      settingsBtn.classList.add('spin-in');
      // stopniowo pokazujemy ikonƒô w czasie animacji
      setTimeout(()=>{ if(settingsIcon) settingsIcon.style.opacity = '1'; }, 120);
      setTimeout(()=>{ settingsBtn.classList.remove('spin-in'); }, 700);
    }, 40);
  }

  settingsBtn.addEventListener('click', (e)=>{
    e.stopPropagation();
    if(settingsBackdrop && settingsBackdrop.classList.contains('show')){ hideSettings(); return; }
    animateButtonOutAndShowPanel();
  });
  closeSettings.addEventListener('click', hideSettings);
  resetBtn.addEventListener('click', resetTheme);

  settingsBtn.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); if(settingsBackdrop && settingsBackdrop.classList.contains('show')) hideSettings(); else animateButtonOutAndShowPanel(); }
  });

  const ITEMS_COUNT = 18;
  const DISC_KEY = 'sg_discovered_v1';
  const LAST_KEY = 'sg_lastDraw_v1';
  const LAST_IDX_KEY = 'sg_lastIndex_v1';

  const drawBtn = document.getElementById('drawBtn');
  const centralImg = document.getElementById('centralImg');
  const placeholderText = document.getElementById('placeholderText');
  const captionEl = document.getElementById('caption');
  const drawCountdownEl = document.getElementById('drawCountdown');
  const dec24El = document.getElementById('dec24');
  const openBook = document.getElementById('openBook');
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modal = document.querySelector('.modal');
  const modalBody = document.getElementById('modalBody');
  const closeModal = document.getElementById('closeModal');
  const foundCountEl = document.getElementById('foundCount');
  const previewEl = document.getElementById('preview');

  function safeGet(key){ try{ return localStorage.getItem(key); }catch(e){ return null; } }
  function safeSet(key,val){ try{ localStorage.setItem(key,val); }catch(e){ console.warn('localStorage set failed',e); } }

  function loadDiscovered(){
    try{
      const raw = safeGet(DISC_KEY);
      if(!raw) return Array(ITEMS_COUNT).fill(false);
      const parsed = JSON.parse(raw);
      if(Array.isArray(parsed) && parsed.length===ITEMS_COUNT) return parsed.map(Boolean);
      // if saved data is for previous smaller set, keep previous discoveries and add false for new items
      if(Array.isArray(parsed) && parsed.length < ITEMS_COUNT){
        const copy = parsed.map(Boolean);
        while(copy.length < ITEMS_COUNT) copy.push(false);
        return copy;
      }
      return Array(ITEMS_COUNT).fill(false);
    }catch(e){ return Array(ITEMS_COUNT).fill(false); }
  }
  function saveDiscovered(){ safeSet(DISC_KEY, JSON.stringify(discovered)); }
  function loadLastDraw(){ try{ const raw = safeGet(LAST_KEY); if(!raw) return null; const d=new Date(raw); return isNaN(d)?null:d; }catch(e){ return null; } }
  function saveLastDraw(d){ try{ safeSet(LAST_KEY, d.toISOString()); }catch(e){} }
  function loadLastIndex(){ try{ const raw = safeGet(LAST_IDX_KEY); if(!raw) return null; const i=parseInt(raw,10); return Number.isInteger(i) && i>=0 && i<ITEMS_COUNT ? i : null; }catch(e){ return null; } }
  function saveLastIndex(i){ safeSet(LAST_IDX_KEY, String(i)); }

  let discovered = loadDiscovered();
  let lastDraw = loadLastDraw();
  let lastIndex = loadLastIndex();

  function randomInt(max){ return Math.floor(Math.random()*max); }

  function tryImageSources(imgEl, index){
    if(!imgEl) return;
    const candidates = [
      `zdjƒôcie_${index+1}.png`,
      `zdjecie_${index+1}.png`,
      `zdjecie-${index+1}.png`,
      `images/zdjƒôcie_${index+1}.png`,
      `images/zdjecie_${index+1}.png`
    ];
    let tried = 0;
    imgEl.onerror = function(){
      tried++;
      if(tried < candidates.length) imgEl.src = candidates[tried];
      else {
        imgEl.src = 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300"><rect width="100%" height="100%" fill="#f3f9ff"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#2b7bd6" font-family="Roboto,Arial" font-size="20">Brak obrazka</text></svg>`);
        imgEl.onerror=null;
      }
    };
    imgEl.src = candidates[0];
  }

  function showPlaceholder(){ if(centralImg) centralImg.style.display='none'; if(placeholderText) placeholderText.style.display='block'; if(previewEl) previewEl.classList.remove('show-overlay'); }
  function showImage(idx){ if(!centralImg) return; tryImageSources(centralImg, idx); centralImg.alt = `Czekoladka ${idx+1}`; centralImg.style.display='block'; if(placeholderText) placeholderText.style.display='none'; if(!discovered[idx]){ centralImg.classList.add('dimmed'); if(previewEl) previewEl.classList.add('show-overlay'); } else { centralImg.classList.remove('dimmed'); if(previewEl) previewEl.classList.remove('show-overlay'); } }

  function getNextDec24(){ const now=new Date(); const y=now.getFullYear(); const cand=new Date(y,11,24,0,0,0); return cand>now?cand:new Date(y+1,11,24,0,0,0); }
  function updateDec24(){ try{ const t=getNextDec24(); const now=new Date(); let diff=Math.max(0,t.getTime()-now.getTime()); const days=Math.floor(diff/(1000*60*60*24)); diff-=days*(1000*60*60*24); const hours=Math.floor(diff/(1000*60*60)); diff-=hours*(1000*60*60); const minutes=Math.floor(diff/(1000*60)); diff-=minutes*(1000*60); const seconds=Math.floor(diff/1000); if(dec24El) dec24El.textContent=`${days} dni ${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`; }catch(e){} }
  function secondsUntilNextDraw(){ if(!lastDraw) return 0; const now=new Date(); const target=new Date(lastDraw.getTime()+24*60*60*1000); return Math.max(0,Math.floor((target.getTime()-now.getTime())/1000)); }
  function formatHMS(sec){ if(sec<=0) return '0:00:00'; const h=Math.floor(sec/3600); const m=Math.floor((sec%3600)/60); const s=sec%60; return `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
  function updateDrawCooldownUI(){ try{ const sec = secondsUntilNextDraw(); if(drawCountdownEl){ if(sec>0){ drawCountdownEl.textContent = formatHMS(sec); if(drawBtn){ drawBtn.textContent='Ju≈º losowa≈Çe≈õ dzi≈õ'; drawBtn.disabled=true; drawBtn.classList.add('inactive'); } } else { drawCountdownEl.textContent='Mo≈ºesz losowaƒá'; if(drawBtn){ drawBtn.textContent='Wylosuj'; drawBtn.disabled=false; drawBtn.classList.remove('inactive'); } } } }catch(e){} }

  let shuffleInterval = null; let isShuffling = false;

  const NEW_PROB = 0.76; // 76% na nowƒÖ, 24% na ju≈º odkrytƒÖ
  function pickFinalIndex(){
    const undiscoveredIdx = [];
    const discoveredIdx = [];
    for(let i = 0; i < ITEMS_COUNT; i++){
      if(discovered[i]) discoveredIdx.push(i);
      else undiscoveredIdx.push(i);
    }

    const chooseNew = Math.random() < NEW_PROB;

    if(chooseNew && undiscoveredIdx.length > 0){
      return undiscoveredIdx[randomInt(undiscoveredIdx.length)];
    }

    if(!chooseNew && discoveredIdx.length > 0){
      return discoveredIdx[randomInt(discoveredIdx.length)];
    }

    if(undiscoveredIdx.length > 0) return undiscoveredIdx[randomInt(undiscoveredIdx.length)];
    if(discoveredIdx.length > 0) return discoveredIdx[randomInt(discoveredIdx.length)];
    return randomInt(ITEMS_COUNT);
  }

  function startShuffle(duration=1400){
    if(isShuffling) return;
    isShuffling = true;
    if(drawBtn){ drawBtn.disabled = true; drawBtn.classList.add('inactive'); drawBtn.textContent = 'Losujƒô‚Ä¶'; }
    if(captionEl) captionEl.textContent = 'Losowanie trwa ‚Äî oglƒÖdaj migawki czekoladek!';

    shuffleInterval = setInterval(()=>{
      const r=randomInt(ITEMS_COUNT);
      showImage(r);
      if(centralImg) centralImg.style.transform = `scale(${1+Math.random()*0.03}) rotate(${(Math.random()-0.5)*5}deg)`;
    }, 70);

    setTimeout(()=>{
      clearInterval(shuffleInterval); shuffleInterval=null;

      const final = pickFinalIndex();

      showImage(final);
      if(centralImg) centralImg.style.transform = 'scale(1) rotate(0deg)';
      if(centralImg) centralImg.classList.add('dimmed');
      if(previewEl) previewEl.classList.add('show-overlay');
      if(captionEl) captionEl.textContent = '...';

      const REVEAL_DELAY = 700;
      setTimeout(()=>{
        if(previewEl) previewEl.classList.remove('show-overlay');
        if(centralImg) centralImg.classList.remove('dimmed');
        if(captionEl) captionEl.textContent = captions[final] || '';

        if(!discovered[final]){
          discovered[final] = true;
          saveDiscovered();
          renderGrid();
        }

        lastDraw = new Date();
        lastIndex = final;
        saveLastDraw(lastDraw);
        saveLastIndex(final);
        updateDrawCooldownUI();
        isShuffling = false;
      }, REVEAL_DELAY);

    }, duration);
  }

  const captions = [
    "Czekoladowy anio≈Çek ‚Äì odm√≥w ‚ÄûZdrowa≈õ Maryjo‚Äù.",
    "Czekoladowa gwiazdka ‚Äì u≈õmiechnij siƒô do kogo≈õ dzi≈õ.",
    "Czekoladowe serduszko ‚Äì powiedz komu≈õ co≈õ mi≈Çego.",
    "Czekoladowy dzwoneczek ‚Äì odm√≥w ‚ÄûOjcze nasz‚Äù.",
    "Czekoladowy renifer ‚Äì pom√≥dl siƒô za kolegƒô lub kole≈ºankƒô.",
    "Czekoladowy krzy≈ºyk ‚Äì pom√≥dl siƒô za osobƒô, kt√≥rej nie lubisz.",
    "Czekoladowa choinka ‚Äì podziƒôkuj Bogu za dzisiejszy dzie≈Ñ.",
    "Czekoladowe dzieciƒÖtko Jezus ‚Äì odm√≥w ‚ÄûAniele Bo≈ºy‚Äù.",
    "Czekoladowy baranek ‚Äì powiedz komu≈õ ‚Äûdziƒôkujƒô‚Äù.",
    "Czekoladowa gwiazdka spadajƒÖca ‚Äì nie k≈Ç√≥ƒá siƒô dzi≈õ z nikim.",
    "Czekoladowy Miko≈Çaj ‚Äì zr√≥b komu≈õ drobnƒÖ przys≈Çugƒô.",
    "Czekoladowy anio≈Ç z trƒÖbkƒÖ ‚Äì pom√≥dl siƒô za swojƒÖ rodzinƒô.",
    "Czekoladowy domek ‚Äì Powstrzymaj siƒô do nastƒôpnego losowania od jedzenia s≈Çodyczy.",
    "Czekoladowy p≈Çatek ≈õniegu ‚Äì postaraj siƒô dzi≈õ byƒá spokojny i mi≈Çy.",
    "Czekoladowy pastuszek ‚Äì odm√≥w ‚ÄûChwa≈Ça Ojcu‚Äù.",
    "Czekoladowa ≈õwieca ‚Äì pom√≥dl siƒô za zmar≈Çych.",
    "Czekoladowy pingwinek ‚Äì Spr√≥buj opowiedzieƒá pod koniec dnia Panu Jezusowi o swoim dniu.",
    "Maryja ‚Äì odm√≥w 10 r√≥≈ºa≈Ñca i ofiaruj jƒÖ w dowolnej intencji."
  ];
  const names = captions.map(c=>{
    // rozbijamy po d≈Çu≈ºszym my≈õlniku (‚Äì) lub kr√≥tszym (-) na wszelki wypadku
    if(c.indexOf('‚Äì') !== -1) return c.split('‚Äì')[0].trim();
    if(c.indexOf('-') !== -1) return c.split('-')[0].trim();
    return c;
  });

  function renderGrid(){ try{
    if(!modalBody) return;
    modalBody.innerHTML='';
    const grid = document.createElement('div'); grid.className='grid';
    for(let idx=0; idx<ITEMS_COUNT; idx++){
      const item = document.createElement('div'); item.className='cardItem'; item.setAttribute('data-index', idx);
      const imgWrap = document.createElement('div'); imgWrap.className='imgWrap';
      const img = document.createElement('img'); tryImageSources(img, idx); img.alt = names[idx] || `Czekoladka ${idx+1}`;
      const overlay = document.createElement('div'); overlay.className='overlay'; overlay.setAttribute('aria-hidden','true'); overlay.textContent='?';
      imgWrap.appendChild(img); imgWrap.appendChild(overlay);
      const name = document.createElement('div'); name.className='name'; name.textContent = discovered[idx] ? names[idx] : '???';
      const desc = document.createElement('div'); desc.className='desc'; desc.textContent = discovered[idx] ? captions[idx] : 'Odkryj tƒô czekoladkƒô, aby poznaƒá misjƒô.';
      if(!discovered[idx]) item.classList.add('dimmed');
      item.appendChild(imgWrap); item.appendChild(name); item.appendChild(desc);
      item.addEventListener('click', ()=>{ showImage(idx); captionEl.textContent = discovered[idx] ? captions[idx] : 'WciƒÖ≈º mo≈ºesz odkryƒá tƒô czekoladkƒô ponownie.'; lastIndex=idx; saveLastIndex(idx); if(modalBackdrop) { modalBackdrop.classList.remove('show'); modalBackdrop.setAttribute('aria-hidden','true'); modal.classList.remove('short-modal'); } });
      grid.appendChild(item);
    }
    modalBody.appendChild(grid);
    if(foundCountEl) foundCountEl.textContent = discovered.filter(Boolean).length;
    updateProgress();
  }catch(e){ console.error('renderGrid error', e); } }

  function updateProgress(){ try{ const found = discovered.filter(Boolean).length; const bar = document.getElementById('progressBar'); const pctEl = document.getElementById('progressPct'); const foundEl = document.getElementById('foundCount'); if(foundEl) foundEl.textContent = found; if(bar) bar.style.width = '0%'; if(pctEl) pctEl.textContent = ''; if(bar) bar.setAttribute('aria-valuenow', '0'); }catch(e){/*silent*/} }

  window.addEventListener('resize', ()=>{});

  if(drawBtn){ drawBtn.addEventListener('click', ()=>{ try{ if(secondsUntilNextDraw()>0){ updateDrawCooldownUI(); return; } startShuffle(1400); }catch(e){} }); }
  if(openBook){ openBook.addEventListener('click', ()=>{ try{ renderGrid(); if(modalBackdrop){ modal.classList.add('short-modal'); modalBackdrop.classList.add('show'); modalBackdrop.setAttribute('aria-hidden','false'); } }catch(e){} }); }
  if(closeModal){ closeModal.addEventListener('click', ()=>{ if(modalBackdrop){ modalBackdrop.classList.remove('show'); modalBackdrop.setAttribute('aria-hidden','true'); modal.classList.remove('short-modal'); } }); }
  if(modalBackdrop){ modalBackdrop.addEventListener('click',(e)=>{ if(e.target===modalBackdrop){ modalBackdrop.classList.remove('show'); modalBackdrop.setAttribute('aria-hidden','true'); modal.classList.remove('short-modal'); } }); }

  document.addEventListener('keydown', (e)=>{ if(modalBackdrop && modalBackdrop.classList.contains('show')){ if(e.key==='ArrowDown') modalBody.scrollBy({top:120,behavior:'smooth'}); if(e.key==='ArrowUp') modalBody.scrollBy({top:-120,behavior:'smooth'}); if(e.key==='PageDown') modalBody.scrollBy({top: modalBody.clientHeight, behavior:'smooth'}); if(e.key==='PageUp') modalBody.scrollBy({top:-modalBody.clientHeight,behavior:'smooth'}); if(e.key==='Escape'){ modalBackdrop.classList.remove('show'); modalBackdrop.setAttribute('aria-hidden','true'); modal.classList.remove('short-modal'); } } });

  (function init(){
    try{
      discovered = loadDiscovered();
      lastDraw = loadLastDraw();
      lastIndex = loadLastIndex();

      if(Number.isInteger(lastIndex) && lastIndex>=0 && lastIndex<ITEMS_COUNT){ showImage(lastIndex); if(captionEl) captionEl.textContent = discovered[lastIndex] ? captions[lastIndex] : 'WciƒÖ≈º mo≈ºesz odkryƒá tƒô czekoladkƒô ponownie.'; }
      else showPlaceholder();

      updateDec24(); updateDrawCooldownUI(); setInterval(updateDec24,1000); setInterval(updateDrawCooldownUI,1000);
      if(foundCountEl) foundCountEl.textContent = discovered.filter(Boolean).length;
      updateProgress();

      loadSavedTheme();
      updateSettingsBtnColor();
      // upewnij siƒô, ≈ºe ikona ma ustawionƒÖ widoczno≈õƒá na starcie
      if(settingsIcon) settingsIcon.style.opacity = '1';
    }catch(e){ console.error('init error', e); }
  })();

  (function(){
    const ONBOARD_KEY = 'sg_onboard_v1';
    const FIRST_DRAW_SHOWN_KEY = 'sg_first_draw_shown_v1';
    function createOverlay(msg, opts){
      opts = opts || {};
      const wrap = document.createElement('div');
      wrap.setAttribute('role','dialog');
      wrap.setAttribute('aria-modal','true');
      wrap.className = 'sg-onboard-overlay';
      Object.assign(wrap.style,{ position:'fixed', inset:0, display:'flex', alignItems:'center', justifyContent:'center', zIndex:4000, background:'transparent', padding:'20px' });

      const box = document.createElement('div');
      box.style.maxWidth = '360px';
      box.style.width = 'min(86vw, 360px)';
      box.style.height = 'auto';
      box.style.borderRadius = '12px';
      box.style.padding = '12px 14px';
      box.style.boxSizing = 'border-box';
      box.style.background = 'rgba(255,255,255,0.06)';
      box.style.border = '1px solid var(--glass-border)';
      box.style.backdropFilter = 'blur(18px) saturate(120%)';
      box.style.webkitBackdropFilter = 'blur(18px) saturate(120%)';
      box.style.color = 'var(--navy)';
      box.style.boxShadow = '0 12px 30px rgba(2,6,23,0.16)';
      box.style.display = 'flex';
      box.style.flexDirection = 'column';
      box.style.gap = '10px';
      box.style.justifyContent = 'center';
      box.style.overflow = 'visible';

      const emoji = document.createElement('div');
      emoji.textContent = opts.emoji || 'üéÑ';
      emoji.style.fontSize = '26px';
      emoji.style.textAlign = 'center';

      const p = document.createElement('div'); p.style.fontSize='15px'; p.style.lineHeight='1.45'; p.style.margin='0'; p.innerHTML = msg;
      const btn = document.createElement('button'); btn.textContent = 'OK'; btn.className = 'small-btn ghost'; btn.style.alignSelf='center'; btn.style.padding='8px 12px'; btn.style.borderRadius='10px'; btn.style.fontWeight='700'; btn.style.cursor='pointer';

      box.appendChild(emoji);
      box.appendChild(p);
      box.appendChild(btn);
      wrap.appendChild(box);
      return {wrap, btn, box, p};
    }function runOnboardingSequence(){
      try{
        if(safeGet(ONBOARD_KEY)) return;
        const steps = [
          'üéÑ Witaj w "Serce Gotowe" ‚Äî dziƒôki kt√≥rej lepiej przygotujesz siƒô na przyj≈õcie Pana Jezusa!',
          'üéÅ Serce Gotowe to tw√≥j wirtualny kalendarz adwentowy ‚Äî do zdobycia jest a≈º 18 unikatowych czekoladek!',
          '‚ú® Odkryj 18 misji, zdobƒÖd≈∫ i wykonaj wszystkie przed 24 grudnia, aby spe≈Çniƒá ≈öwiƒÖteczne Wyzwanie! Co 24 godziny losuj czekoladkƒô ‚Äî naci≈õnij "Wylosuj!"'
        ];

        let idx = 0;
        const {wrap, btn, p} = createOverlay(steps[idx]);
        document.body.appendChild(wrap);
        btn.focus();
        btn.addEventListener('click', function handler(){
          idx++;
          if(idx < steps.length){ p.innerHTML = steps[idx]; return; }
          document.body.removeChild(wrap);
          try{ safeSet(ONBOARD_KEY, '1'); }catch(e){}
        });
      }catch(e){ console.error('onboarding error', e); }
    }
    try{ runOnboardingSequence(); }catch(e){}
    (function watchFirstDraw(){
      try{
        let prev = safeGet(LAST_KEY);
        const check = function(){
          const now = safeGet(LAST_KEY);
          const onboardDone = !!safeGet(ONBOARD_KEY);
          const firstShown = !!safeGet(FIRST_DRAW_SHOWN_KEY);
          if(onboardDone && !firstShown && now && now !== prev){
            prev = now;
            setTimeout(()=>{
              try{
                const msg = 'O to twoja pierwsza czekoladka! Wszystkie kt√≥re zdoby≈Çe≈õ/a≈õ mo≈ºesz podglƒÖdnƒÖƒá w Ksiƒôdze Czekoladek! SƒÖ tam tak≈ºe te do odblokowania! Mo≈ºesz tak≈ºe dostosowaƒá swojƒÖ Aplikacjƒô po swojemu, naciskajƒÖc ikonkƒô ustawie≈Ñ! POWODZENIA!';
                const {wrap, btn} = createOverlay(msg);
                document.body.appendChild(wrap);
                btn.focus();
                btn.addEventListener('click', ()=>{ try{ document.body.removeChild(wrap); safeSet(FIRST_DRAW_SHOWN_KEY,'1'); }catch(e){} });
              }catch(e){ console.error('first-draw message error', e); }
            }, 1500);
          } else {
            prev = now;
          }
        };
        const poll = setInterval(check, 700);
        window.addEventListener('beforeunload', ()=>{ clearInterval(poll); });
      }catch(e){ console.error('watchFirstDraw error', e); }
    })();
  })();

  window.sg_debug = { discovered, resetProgress: ()=>{ discovered = Array(ITEMS_COUNT).fill(false); saveDiscovered(); updateProgress(); renderGrid(); }, refreshUI: ()=>{ discovered = loadDiscovered(); updateProgress(); renderGrid(); } };

}catch(err){ console.error('fatal app error', err); }
})();
</script>
</body>
</html>




